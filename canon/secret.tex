
% Van de Graaf
% works for any page proportion

% footer: https://eksith.wordpress.com/tag/van-de-graaf/

% nb. textheight cannot be set; it is calculated from height-(header+headerdistance+footer+footerdistance). to account for leading which does not divide exactly into the textheight, themes would adjust headerdistance such that the bottom line lands exactly on the bottom of the text area

\startenvironment secret

	% TODO: set double page here; it's a default for this canon
	% but a theme could override that for a single page layout,
	% if it were really appropriate
	\setuppagenumbering[alternative=doublesided]

	\startMPdefinitions
	\stopMPdefinitions

	\startMPdefinitions
		def canon(expr h, w) =
			path p, q;
			path e, f, g, i;

			p := (w, 0) -- (0,   h);
			q := (w, h) -- (0, .5h);

			z0 = p intersectionpoint q; % centre point

			z1 = (xpart  z0, h); % top
			z2 = (xpart -z0, ypart z0); % elbow off page

			z3 = (z1 -- z2) intersectionpoint (origin -- h * up); % point on edge
			z4 = (z1 -- z2) intersectionpoint p; % text area top left

			e := (0, ypart z4) -- (w, ypart z4);

			z5 = e intersectionpoint q; % text area top right

			f := (xpart z5, h) -- (xpart z5, 0);

			z6 = f intersectionpoint p; % text area bottom right

			g := (0, ypart z6) -- (w, ypart z6);

			i := (xpart z4, 0) -- (xpart z4, h);

			draw p withcolor blue;
			draw q withcolor blue;
			draw z0 -- z1 -- z3 withcolor blue;

			draw e withcolor red; % top
			draw f withcolor red; % right
			draw g withcolor red; % bottom
			draw i withcolor red; % left
		enddef;

		% footer by eksith, https://eksith.wordpress.com/tag/van-de-graaf/
		def footer(expr h, w) =
			path a, b, c;
			path j, k, l;

			a := (0, 0) -- (w, ypart z6);
			b := (w, 0) -- (0, ypart z6);
			c := (w, 0) -- (0, .5h);

			z7 = a intersectionpoint b; % centre point

			j := (0, ypart z7) -- (w, ypart z7);

			z8 = a intersectionpoint p; % left margin elbow

			k := (0, ypart z8) -- (w, ypart z8);

			z9 = a intersectionpoint c; % outer limit

			l := (xpart z9, ypart z7) -- (xpart z9, ypart z8);

			draw a withcolor green;
			draw b withcolor green;
			draw c withcolor green;

			draw j withcolor red; % bottom
			draw k withcolor red; % top
			draw l withcolor red; % right
		enddef;
	\stopMPdefinitions

	\startreusableMPgraphic{canon-recto}
		h := \overlayheight;
		w := \overlaywidth;
		canon(h, w);
		footer(h, w);
	\stopreusableMPgraphic

	\startreusableMPgraphic{canon-verso}
		h := \overlayheight;
		w := \overlaywidth;
		canon(h, -w);
		footer(h, -w);
	\stopreusableMPgraphic

	\startmode[debug]
		\defineoverlay[canon-recto] [\reusableMPgraphic{canon-recto}]
		\defineoverlay[canon-verso] [\reusableMPgraphic{canon-verso}]

		\setupbackgrounds[leftpage] [background={canon-verso, footer-verso}]
		\setupbackgrounds[rightpage][background={canon-recto, footer-recto}]
	\stopmode

	\startMPcalculation
		h := PaperHeight;
		w := PaperWidth;
		canon(h, w);
		footer(h, w);

		passvariable("canon:textleft",   xpart z4);
		passvariable("canon:textright",  xpart z5);
		passvariable("canon:textwidth",  xpart z5 - xpart z4);
		passvariable("canon:texttop",    h - ypart z4);
		passvariable("canon:textbottom", ypart z6);
		passvariable("canon:textheight", ypart z4 - ypart z6);

		passvariable("canon:footertop",    ypart z8);
		passvariable("canon:footerbottom", ypart z7);
		passvariable("canon:footerheight", ypart z8 - ypart z7);
	\stopMPcalculation

	\setuplayout[
		header=\bodyfontsize,
		headerdistance=\bodyfontsize, % XXX: this ought to be found geometrically
		top=0pt,
		topspace=\dimexpr\MPrunvar{canon:texttop}bp-\headerheight-\headerdistance\relax,
		footer=0pt, % TODO: \MPrunvar{canon:footerheight}bp,
		footerdistance=0pt, % TODO: \dimexpr\MPrunvar{canon:textbottom}bp-\MPrunvar{canon:footertop}bp\relax,
		height=\dimexpr\MPrunvar{canon:textheight}bp
			+\headerheight+\headerdistance
			+\footerheight+\footerdistance\relax,
		backspace=\MPrunvar{canon:textleft}bp,
		margin=0pt, % TODO: find where to put this
		width=\MPrunvar{canon:textwidth}bp,
	]

% TODO: frame or something inside footer
%\setupbackgrounds[footer][text][frame=on, background=color, backgroundcolor=blue]

%\def\eksithfooter#1{\framed[background=color,backgroundcolor=red,before=abc,after=xyz]{\bf #1}}

%\setupfooter[strut=no]
%\setupfootnotes[
%	rule=off,
%	location=page,
%	margindistance=3cm,
%	textcommand=\eksithfooter,
%	color=blue,
%	frame=on]
%\setupfootertexts[{\framed[frame=on,height=\footerheight]{offset}}][]

%\setuppagenumbering
%	[location={footer,middle}, before=abc]

\stopenvironment

