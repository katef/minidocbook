
% XXX: could have different setups for refentry vs. other documents

% TODO: xinclude: http://wiki.contextgarden.net/Command/xmlinclude

% XXX: \definestartstop left=,right= polyfill until this is committed to ConTeXt proper
\unprotect
\unexpanded\def\syst_startstop_indeed#1%
  {\groupedcommand
     {\def\currentstartstop{#1}%
\startstopparameter\c!commands % better: setups so that will show op soon
      \dostarttagged\t!construct\currentstartstop
      \usestartstopstyleandcolor\c!style\c!color
      \startstopparameter\c!left}
     {\def\currentstartstop{#1}% safeguard, nto really needed
      \startstopparameter\c!right
      \dostoptagged
      \startstopparameter\c!inbetween}}
\protect

\input /home/kate/svn/www/wc/minidocbook/tex/minidocbook/primitive
\input /home/kate/svn/www/wc/minidocbook/tex/minidocbook/blocks
\input /home/kate/svn/www/wc/minidocbook/tex/minidocbook/inline
\input /home/kate/svn/www/wc/minidocbook/tex/minidocbook/lists
\input /home/kate/svn/www/wc/minidocbook/tex/minidocbook/links
\input /home/kate/svn/www/wc/minidocbook/tex/minidocbook/table

\startxmlsetups xml:mdb-refentry
	\xmlsetsetup{\xmldocument}{*}{-}
	\xmlsetsetup{\xmldocument}{refentry|refname|refnamediv|refsynopsisdiv|refsection}{xml:*}
	\xmlsetsetup{\xmldocument}{author|firstname|surname|affiliation|orgname}{xml:*}
	\xmlsetsetup{\xmldocument}{cmdsynopsis|synopsis}{xml:*}
	\xmlsetsetup{\xmldocument}{arg|group|sbr}{xml:*}

	\xmlsetsetup{\xmldocument}{para}{xml:*}
	\xmlsetsetup{\xmldocument}{synopsis}{xml:*}
%	\xmlsetfunction{\xmldocument}{synopsis}{mdb_synopsis}
 
	\xmlsetsetup{\xmldocument}{acronym}{xml:*}
	\xmlsetsetup{\xmldocument}{command}{xml:*}
	\xmlsetsetup{\xmldocument}{userinput|computeroutput}{xml:*}
	\xmlsetsetup{\xmldocument}{application}{xml:*}
	\xmlsetsetup{\xmldocument}{code}{xml:*}
	\xmlsetsetup{\xmldocument}{varname|type|token|parameter|constant|function|literal}{xml:*}
	\xmlsetsetup{\xmldocument}{emphasis}{xml:*}
	\xmlsetsetup{\xmldocument}{superscript|subscript}{xml:*}
	\xmlsetsetup{\xmldocument}{option}{xml:*}
	\xmlsetsetup{\xmldocument}{filename}{xml:*}
	\xmlsetsetup{\xmldocument}{replaceable|citetitle|firstterm}{xml:*}
	\xmlsetsetup{\xmldocument}{quote}{xml:*}

	\xmlsetsetup{\xmldocument}{orderedlist|itemizedlist|listitem}{xml:*}
%	\xmlsetsetup{\xmldocument}{variablelist}{xml:*}
	\xmlsetsetup{\xmldocument}{varlistentry}{xml:*}
	\xmlsetsetup{\xmldocument}{term}{xml:*}
%	\xmlsetsetup{\xmldocument}{variablelist}{xml:*}

%	\xmlfilter{\xmldocument}{/varlistentry/listitem/command(xml:varlistitem)}
% TODO: different term for refsection[title = 'Options']/variablelist/varlistentry/term
% TODO: different term for refsection[title = 'Options']/variablelist
%	\xmlfilter{\xmldocument}{variablelist/command(xml:vl2)}

	\xmlsetsetup{\xmldocument}{reflink|xref|citerefentry|ulink|link}{xml:*}
	\xmlsetsetup{\xmldocument}{refentrytitle|manvolnum}{xml:*}

	\xmlsetsetup{\xmldocument}{table|col|thead|tbody|tr|th|td}{xml:*}


	\xmlsetsetup{\xmldocument}{variablelist}{xml:*}
\stopxmlsetups

\xmlregistersetup{xml:mdb-refentry}


\startxmlsetups xml:refentry

	\startbodymatter

	\xmlflush{#1}

	% TODO: only if present
	\startsection[title=Author,reference=sec:TODO]
		\xmlall{#1}{/refentryinfo/author}
	\stopsection

	\stopbodymatter
\stopxmlsetups

\startxmlsetups xml:author
	% XXX: copy the scheme per the html xslt
	\xmlconcat{#1}{firstname|surname}{ }
	{, }
	\xmlall{#1}{affiliation}
\stopxmlsetups

\startxmlsetups xml:firstname
	\xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:surname
	\xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:affiliation
	\xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:orgname
	\xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:refname
	\xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:refnamediv
	\startsection[title=Name,reference=sec:TODO]
	\xmlconcat{#1}{refname}{, }
	\thinspaceâ€”\thinspace
	\xmltext{#1}{refpurpose}
	\stopsection
\stopxmlsetups

\startxmlsetups xml:refsynopsisdiv
	\startsection[title=Synopsis,reference=sec:TODO]
	\xmlflush{#1}
	\stopsection
\stopxmlsetups

\startxmlsetups xml:arg
	\doifelse{\xmlatt{#1}{choice}} {opt}
		{[\thinspace\xmlflush{#1}\thinspace] }
		{\thinspace\xmlflush{#1}\thinspace}
\stopxmlsetups

\startxmlsetups xml:group
	\doifelse{\xmlatt{#1}{choice}} {opt}
		{[\xmlconcat{#1}{arg}{\|}]}
		{\{\xmlconcat{#1}{arg}{\|}\}}
\stopxmlsetups

\startxmlsetups xml:sbr
	\crlf
\stopxmlsetups

% XXX: why isn't width automatically correct here?
\definedescription[synopsis][headstyle=normal,width=1.5em]

\startxmlsetups xml:cmdsynopsis
	\startsynopsis{\xmltext{#1}{command}}
	\xmlall{#1}{/arg|group|sbr}
	\stopsynopsis
\stopxmlsetups

\startxmlsetups xml:refsection
	\startsection[title={\xmltext{#1}{title}},reference=sec:TODO]
	\xmlflush{#1}
	\stopsection
\stopxmlsetups

\environment env/manpage

% XXX: doesn't belong here
\input tex/kmkf-setup
%\input tex/bp-setup
\input tex/kmkf-debug

% XXX: doesn't belong here
\Revision[4]
\Product[KMKF]
\Document[Manual]
\Author[Katherine Flavel]
\Classify[]

