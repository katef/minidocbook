
\definehead [Reference] [chapter]
\definehead [Refentry]  [chapter]

\startxmlsetups mdb:setup-refentry
	\xmlsetsetup{\xmldocument}{synopsis}{mdb:*} % XXX: duplicate
%	\xmlsetfunction{\xmldocument}{synopsis}{mdb_synopsis}

	\xmlsetsetup{\xmldocument}{reference}{mdb:reference}
	\xmlsetsetup{\xmldocument}{refentry}{mdb:collated-refentry}
	\xmlsetsetup{\xmldocument}{/refentry}{mdb:single-refentry}

	\xmlsetsetup{\xmldocument}{refname|refnamediv|refsynopsisdiv|refsection}{mdb:*}
	\xmlsetsetup{\xmldocument}{author|firstname|surname|affiliation|orgname}{mdb:*}
	\xmlsetsetup{\xmldocument}{cmdsynopsis|synopsis}{mdb:*}
	\xmlsetsetup{\xmldocument}{arg|group|sbr}{mdb:*}
\stopxmlsetups

\xmlregistersetup{mdb:setup-refentry}

% TODO: centralise refentry guts
\startxmlsetups mdb:single-refentry

	\startbodymatter

	\xmlflush{#1}

	% TODO: only if present
%	\startsection[title=Author,reference=sec:TODO]
%		\xmlall{#1}{/refentryinfo/author}
%	\stopsection

	\stopbodymatter

\stopxmlsetups

\startxmlsetups mdb:reference

	\startReference[title=\xmltext{#1}{./title}]

	\xmlflush{#1}

	\stopReference

\stopxmlsetups

\startxmlsetups mdb:collated-refentry

	% TODO: handle multiple refnames
	\startRefentry[title=\xmltext{#1}{refnamediv/refname}(\xmltext{#1}{refmeta/manvolnum})]

	\xmlflush{#1}

	% TODO: only if present
%	\startsection[title=Author,reference=sec:TODO]
%		\xmlall{#1}{/refentryinfo/author}
%	\stopsection

	\stopRefentry

\stopxmlsetups

\startxmlsetups mdb:author
	% XXX: copy the scheme per the html xslt
	\xmlconcat{#1}{firstname|surname}{ }
	{, }
	\xmlall{#1}{affiliation}
\stopxmlsetups

\startxmlsetups mdb:firstname
	\xmlflush{#1}
\stopxmlsetups

\startxmlsetups mdb:surname
	\xmlflush{#1}
\stopxmlsetups

\startxmlsetups mdb:affiliation
	\xmlflush{#1}
\stopxmlsetups

\startxmlsetups mdb:orgname
	\xmlflush{#1}
\stopxmlsetups

\startxmlsetups mdb:refname
	\xmlflush{#1}
\stopxmlsetups

\startxmlsetups mdb:refnamediv
	\startsection[title=Name,reference=sec:TODO]
	\xmlconcat{#1}{refname}{, }
	\thinspaceâ€”\thinspace
	\xmltext{#1}{refpurpose}
	\stopsection
\stopxmlsetups

\startxmlsetups mdb:refsynopsisdiv
	\startsection[title=Synopsis,reference=sec:TODO]
	\xmlflush{#1}
	\stopsection
\stopxmlsetups

\startxmlsetups mdb:arg
	\doifelse{\xmlatt{#1}{choice}} {opt}
		{[\thinspace\xmlflush{#1}\thinspace] }
		{\thinspace\xmlflush{#1}\thinspace}
\stopxmlsetups

\startxmlsetups mdb:group
	\doifelse{\xmlatt{#1}{choice}} {opt}
		{[\xmlconcat{#1}{arg}{\|}]}
		{\{\xmlconcat{#1}{arg}{\|}\}}
\stopxmlsetups

\startxmlsetups mdb:sbr
	\crlf
\stopxmlsetups

% XXX: why isn't width automatically correct here?
\definedescription[synopsis][headstyle=normal,width=1.5em]

\startxmlsetups mdb:cmdsynopsis
	\startsynopsis{\xmltext{#1}{command}}
	\xmlall{#1}{/arg|group|sbr}
	\stopsynopsis
\stopxmlsetups

\startxmlsetups mdb:refsection
	\startsection[title={\xmltext{#1}{title}},reference=sec:TODO]
	\xmlflush{#1}
	\stopsection
\stopxmlsetups

