
\startenvironment manpage

	\definemarking[Reference]     % libmct
	\definemarking[Refentrytitle] % mct_init/fini
	\definemarking[Refname]       % mct_init,mct_fini
	\definemarking[Manvolnum]     % 3

	\setuphead[part][
		placehead=yes,
		number=no]

	\setuphead[Reference][
		placehead=yes,
		number=no,
		page=yes,
		bodypartlabel=part]

	\setuphead[Refentry][
		number=no,
		page=yes,
		placehead=empty, % shown in header instead
		after={\blank[none]\blank[nowhite, disable]}] % suppresses blank line after placehead=empty

	% TODO: make this indent a configurable variable
	\setuphead[section][
		number=no,
		page=no,
		style=\WORD\bf,
		after={\startnarrower[1.5cm]},
		aftersection={\stopnarrower}]

	\setupcombinedlist[content][list={part,Reference,Refentry}]

	\startsetups[Manpage:header-left]
		\doiftext{\getmarking[Product]}{\bf \getmarking[Product]}
		\getmarking[Parttitle]%
			\doiftext{\getmarking[Reference]}{: \getmarking[Reference]}
	\stopsetups

	\startsetups[Manpage:header-right]
		\feature[+][f:smcp]
		\getmarking[Refentrytitle](\getmarking[Manvolnum])
	\stopsetups

	\startsetups[Manpage:footer]
		\rlap{\getmarking[Company]}
		\hfill
		\setup{doc:classify}
		\hfill
		\llap{\pagenumber}
	\stopsetups

	\setupheadertexts[\setups{Manpage:header-left}][\setups{Manpage:header-right}]
	\setupfootertexts[\setups{Manpage:footer}][]

	\startsetups[Reference:before]
		\ifconditional\libraryentries
			% making a page; the second library page onwards
			\page
		\else
			% not making a page; this is on the part title page
			\settrue\libraryentries
		\fi
	\stopsetups

	\startsetups[Reference:after]
		\startframed[frame=off,width=\textwidth,height=\dimexpr\textheight-\strutdp\relax,align={middle,lohi}]
			\placeheadtext[part]
			\placeheadtext[Reference]
		\stopframed
		\page
	\stopsetups

	\newconditional\libraryentries
	\settrue\libraryentries

	\startsetups[xlibraryentries]
		\determinelistcharacteristics[Reference]
		\ifnum\structurelistsize=0
			\startframed[frame=off,width=\textwidth,height=\dimexpr\textheight-\strutdp\relax,align={middle,lohi}]
			\placeheadtext[part]
			\stopframed
		\else
			\setfalse\libraryentries
		\fi
	\stopsetups

	\setuphead[part,Reference][
		placehead=empty,
		page=no]

	\setuphead[part][
		after=\directsetup{xlibraryentries}]

	% XXX: this causes the PDF bookmark to be on the page before
	% is there something I can use other than before=, after=?
	\setuphead[Reference][
		before=\directsetup{Reference:before},
		after=\directsetup{Reference:after}]

\stopenvironment

