
\startenvironment manpage

	\setuphead[part][
		placehead=yes,
		number=no]

	\setuphead[Reference][
		placehead=yes,
		number=no,
		page=yes,
		bodypartlabel=part]

	\setuphead[Refentry][
		number=no,
		page=yes]

	\setuphead[section][
		number=no,
		page=no,
		style=\WORD\bf,
		after={\startnarrower[1.5cm]},
		aftersection={\stopnarrower}]

	\setvariable{env}{manual}{{\bf KMKF} Manual}
	\setvariable{env}{company}{kmkf.elide.org}
	\setvariable{env}{manpage}{INSTALL(7MK)}

	\setupcombinedlist[content][list={part,Reference,Refentry}]

	\startsetups[text a]
		\rlap{\getvariable{env}{manpage}}
		\hfill
		\getvariable{env}{manual}
		\hfill
		\llap{\getvariable{env}{manpage}}
	\stopsetups

	\startsetups[text b]
		\rlap{\getvariable{env}{company}}
		\hfill
		\setup{doc:classify}
		\hfill
		\llap{\pagenumber}
	\stopsetups

	\setupheadertexts[\setups{text a}][]
	\setupfootertexts[\setups{text b}][]

	% XXX:
%	\setupheadertexts[{MCT(1)}\hfill {MCT Programmer's manual} \hfill {MCT(1)}][]
%	\setupfootertexts[Bubblephone Ltd.\setup{doc:classify}][\small\pagenumber]
%	\setupfootertexts[\setup{doc:classify}][\setup{doc:revision}]


	\startsetups[Reference:before]
		\ifconditional\libraryentries
			% making a page; the second library page onwards
			\page
		\else
			% not making a page; this is on the part title page
			\settrue\libraryentries
		\fi
	\stopsetups

	\startsetups[Reference:after]
		\startframed[frame=off,width=\textwidth,height=\dimexpr\textheight-\strutdp\relax,align={middle,lohi}]
			\placeheadtext[part]
			\placeheadtext[Reference]
		\stopframed
		\page
	\stopsetups

	\newconditional\libraryentries
	\settrue\libraryentries

	\startsetups[xlibraryentries]
		\determinelistcharacteristics[Reference]
		\ifnum\structurelistsize=0
			\startframed[frame=off,width=\textwidth,height=\dimexpr\textheight-\strutdp\relax,align={middle,lohi}]
			\placeheadtext[part]
			\stopframed
		\else
			\setfalse\libraryentries
		\fi
	\stopsetups

	\setuphead[part,Reference][
		placehead=empty,
		page=no]

	\setuphead[part][
		after=\directsetup{xlibraryentries}]

	% XXX: this causes the PDF bookmark to be on the page before
	% is there something I can use other than before=, after=?
	\setuphead[Reference][
		before=\directsetup{Reference:before},
		after=\directsetup{Reference:after}]

\stopenvironment

